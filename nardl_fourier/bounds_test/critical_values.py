"""
PSS (Pesaran, Shin & Smith, 2001) Critical Values for Bounds Testing
=====================================================================

Critical values for F-test and t-test from:
Pesaran, M. H., Shin, Y., & Smith, R. J. (2001). Bounds testing approaches 
to the analysis of level relationships. Journal of Applied Econometrics, 16(3), 289-326.

Also includes critical values from Narayan (2005) for small samples.

Author: Dr. Merwan Roudane
"""

import numpy as np

# =============================================================================
# PSS (2001) Critical Values - Case III (Unrestricted Intercept, No Trend)
# =============================================================================
# Most commonly used case for NARDL models
# k = number of I(1) regressors in the long-run relationship

PSS_CRITICAL_VALUES_CASE_III = {
    'F': {
        # k: {significance: (I(0) bound, I(1) bound)}
        0: {'10%': (6.58, 6.58), '5%': (8.21, 8.21), '2.5%': (9.80, 9.80), '1%': (11.79, 11.79)},
        1: {'10%': (4.04, 4.78), '5%': (4.94, 5.73), '2.5%': (5.77, 6.68), '1%': (6.84, 7.84)},
        2: {'10%': (3.17, 4.14), '5%': (3.79, 4.85), '2.5%': (4.41, 5.52), '1%': (5.15, 6.36)},
        3: {'10%': (2.72, 3.77), '5%': (3.23, 4.35), '2.5%': (3.69, 4.89), '1%': (4.29, 5.61)},
        4: {'10%': (2.45, 3.52), '5%': (2.86, 4.01), '2.5%': (3.25, 4.49), '1%': (3.74, 5.06)},
        5: {'10%': (2.26, 3.35), '5%': (2.62, 3.79), '2.5%': (2.96, 4.18), '1%': (3.41, 4.68)},
        6: {'10%': (2.12, 3.23), '5%': (2.45, 3.61), '2.5%': (2.75, 3.99), '1%': (3.15, 4.43)},
        7: {'10%': (2.03, 3.13), '5%': (2.32, 3.50), '2.5%': (2.60, 3.84), '1%': (2.96, 4.26)},
        8: {'10%': (1.95, 3.06), '5%': (2.22, 3.39), '2.5%': (2.48, 3.70), '1%': (2.79, 4.10)},
        9: {'10%': (1.88, 2.99), '5%': (2.14, 3.30), '2.5%': (2.37, 3.60), '1%': (2.65, 3.97)},
        10: {'10%': (1.83, 2.94), '5%': (2.06, 3.24), '2.5%': (2.28, 3.50), '1%': (2.54, 3.86)},
    },
    't': {
        # t-statistic critical values (for ECT coefficient)
        0: {'10%': (-2.57, -2.57), '5%': (-2.86, -2.86), '2.5%': (-3.13, -3.13), '1%': (-3.43, -3.43)},
        1: {'10%': (-2.57, -2.91), '5%': (-2.86, -3.22), '2.5%': (-3.13, -3.50), '1%': (-3.43, -3.82)},
        2: {'10%': (-2.57, -3.21), '5%': (-2.86, -3.53), '2.5%': (-3.13, -3.80), '1%': (-3.43, -4.10)},
        3: {'10%': (-2.57, -3.46), '5%': (-2.86, -3.78), '2.5%': (-3.13, -4.05), '1%': (-3.43, -4.37)},
        4: {'10%': (-2.57, -3.66), '5%': (-2.86, -3.99), '2.5%': (-3.13, -4.26), '1%': (-3.43, -4.60)},
        5: {'10%': (-2.57, -3.86), '5%': (-2.86, -4.19), '2.5%': (-3.13, -4.46), '1%': (-3.43, -4.79)},
        6: {'10%': (-2.57, -4.04), '5%': (-2.86, -4.38), '2.5%': (-3.13, -4.66), '1%': (-3.43, -4.99)},
        7: {'10%': (-2.57, -4.23), '5%': (-2.86, -4.57), '2.5%': (-3.13, -4.85), '1%': (-3.43, -5.19)},
        8: {'10%': (-2.57, -4.40), '5%': (-2.86, -4.72), '2.5%': (-3.13, -5.02), '1%': (-3.43, -5.37)},
        9: {'10%': (-2.57, -4.56), '5%': (-2.86, -4.88), '2.5%': (-3.13, -5.18), '1%': (-3.42, -5.54)},
        10: {'10%': (-2.57, -4.69), '5%': (-2.86, -5.03), '2.5%': (-3.13, -5.34), '1%': (-3.43, -5.68)},
    }
}

# =============================================================================
# Case II: Restricted Intercept, No Trend
# =============================================================================
PSS_CRITICAL_VALUES_CASE_II = {
    'F': {
        0: {'10%': (4.04, 4.04), '5%': (4.94, 4.94), '1%': (6.84, 6.84)},
        1: {'10%': (3.02, 3.51), '5%': (3.62, 4.16), '1%': (4.94, 5.58)},
        2: {'10%': (2.63, 3.35), '5%': (3.10, 3.87), '1%': (4.13, 5.00)},
        3: {'10%': (2.37, 3.20), '5%': (2.79, 3.67), '1%': (3.65, 4.66)},
        4: {'10%': (2.20, 3.09), '5%': (2.56, 3.49), '1%': (3.29, 4.37)},
        5: {'10%': (2.08, 3.00), '5%': (2.39, 3.38), '1%': (3.06, 4.15)},
    },
    't': {
        0: {'10%': (-2.57, -2.57), '5%': (-2.86, -2.86), '1%': (-3.43, -3.43)},
        1: {'10%': (-2.57, -2.91), '5%': (-2.86, -3.22), '1%': (-3.43, -3.82)},
        2: {'10%': (-2.57, -3.21), '5%': (-2.86, -3.53), '1%': (-3.43, -4.10)},
        3: {'10%': (-2.57, -3.46), '5%': (-2.86, -3.78), '1%': (-3.43, -4.37)},
        4: {'10%': (-2.57, -3.66), '5%': (-2.86, -3.99), '1%': (-3.43, -4.60)},
        5: {'10%': (-2.57, -3.86), '5%': (-2.86, -4.19), '1%': (-3.43, -4.79)},
    }
}

# =============================================================================
# Case IV: Unrestricted Intercept, Restricted Trend
# =============================================================================
PSS_CRITICAL_VALUES_CASE_IV = {
    'F': {
        0: {'10%': (5.37, 5.37), '5%': (6.29, 6.29), '2.5%': (7.14, 7.14), '1%': (8.26, 8.26)},
        1: {'10%': (4.05, 4.49), '5%': (4.68, 5.15), '2.5%': (5.30, 5.83), '1%': (6.10, 6.73)},
        2: {'10%': (3.38, 4.02), '5%': (3.88, 4.61), '2.5%': (4.37, 5.16), '1%': (4.99, 5.85)},
        3: {'10%': (2.97, 3.74), '5%': (3.38, 4.23), '2.5%': (3.80, 4.68), '1%': (4.30, 5.23)},
        4: {'10%': (2.68, 3.53), '5%': (3.05, 3.97), '2.5%': (3.40, 4.36), '1%': (3.81, 4.92)},
        5: {'10%': (2.49, 3.38), '5%': (2.81, 3.76), '2.5%': (3.11, 4.13), '1%': (3.50, 4.63)},
        6: {'10%': (2.33, 3.25), '5%': (2.63, 3.62), '2.5%': (2.90, 3.94), '1%': (3.27, 4.39)},
        7: {'10%': (2.22, 3.17), '5%': (2.50, 3.50), '2.5%': (2.76, 3.81), '1%': (3.07, 4.23)},
        8: {'10%': (2.13, 3.09), '5%': (2.38, 3.41), '2.5%': (2.62, 3.70), '1%': (2.93, 4.06)},
        9: {'10%': (2.05, 3.02), '5%': (2.30, 3.33), '2.5%': (2.52, 3.60), '1%': (2.79, 3.93)},
        10: {'10%': (1.98, 2.97), '5%': (2.21, 3.25), '2.5%': (2.42, 3.52), '1%': (2.68, 3.84)},
    },
    't': {
        1: {'10%': (-3.13, -3.40), '5%': (-3.41, -3.69), '1%': (-3.96, -4.26)},
        2: {'10%': (-3.13, -3.55), '5%': (-3.41, -3.83), '1%': (-3.96, -4.36)},
        3: {'10%': (-3.13, -3.66), '5%': (-3.41, -3.95), '1%': (-3.96, -4.49)},
        4: {'10%': (-3.13, -3.75), '5%': (-3.41, -4.04), '1%': (-3.96, -4.60)},
        5: {'10%': (-3.13, -3.83), '5%': (-3.41, -4.13), '1%': (-3.96, -4.69)},
    }
}

# =============================================================================
# Case V: Unrestricted Intercept, Unrestricted Trend
# =============================================================================
PSS_CRITICAL_VALUES_CASE_V = {
    'F': {
        0: {'10%': (9.81, 9.81), '5%': (11.64, 11.64), '2.5%': (13.36, 13.36), '1%': (15.73, 15.73)},
        1: {'10%': (5.59, 6.26), '5%': (6.56, 7.30), '2.5%': (7.46, 8.27), '1%': (8.74, 9.63)},
        2: {'10%': (4.19, 5.06), '5%': (4.87, 5.85), '2.5%': (5.49, 6.59), '1%': (6.34, 7.52)},
        3: {'10%': (3.47, 4.45), '5%': (4.01, 5.07), '2.5%': (4.52, 5.62), '1%': (5.17, 6.36)},
        4: {'10%': (3.03, 4.06), '5%': (3.47, 4.57), '2.5%': (3.89, 5.07), '1%': (4.40, 5.72)},
        5: {'10%': (2.75, 3.79), '5%': (3.12, 4.25), '2.5%': (3.47, 4.67), '1%': (3.93, 5.23)},
        6: {'10%': (2.53, 3.59), '5%': (2.87, 4.00), '2.5%': (3.19, 4.38), '1%': (3.60, 4.90)},
        7: {'10%': (2.38, 3.45), '5%': (2.69, 3.83), '2.5%': (2.98, 4.16), '1%': (3.34, 4.63)},
        8: {'10%': (2.26, 3.34), '5%': (2.55, 3.68), '2.5%': (2.82, 4.02), '1%': (3.15, 4.43)},
        9: {'10%': (2.16, 3.24), '5%': (2.43, 3.56), '2.5%': (2.67, 3.87), '1%': (2.97, 4.24)},
        10: {'10%': (2.07, 3.16), '5%': (2.33, 3.46), '2.5%': (2.56, 3.76), '1%': (2.84, 4.10)},
    },
    't': {
        1: {'10%': (-3.13, -3.40), '5%': (-3.41, -3.69), '1%': (-3.96, -4.26)},
        2: {'10%': (-3.13, -3.55), '5%': (-3.41, -3.83), '1%': (-3.96, -4.36)},
        3: {'10%': (-3.13, -3.66), '5%': (-3.41, -3.95), '1%': (-3.96, -4.49)},
        4: {'10%': (-3.13, -3.75), '5%': (-3.41, -4.04), '1%': (-3.96, -4.60)},
        5: {'10%': (-3.13, -3.83), '5%': (-3.41, -4.13), '1%': (-3.96, -4.69)},
    }
}

# =============================================================================
# Narayan (2005) Small Sample Critical Values - Case III
# =============================================================================
# For sample sizes: 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80
NARAYAN_CRITICAL_VALUES = {
    'F': {
        30: {
            1: {'10%': (4.26, 5.20), '5%': (5.15, 6.27), '1%': (7.17, 8.54)},
            2: {'10%': (3.41, 4.45), '5%': (4.13, 5.36), '1%': (5.75, 7.26)},
            3: {'10%': (2.96, 4.17), '5%': (3.54, 4.84), '1%': (4.92, 6.46)},
            4: {'10%': (2.64, 3.84), '5%': (3.16, 4.53), '1%': (4.37, 5.97)},
            5: {'10%': (2.41, 3.61), '5%': (2.88, 4.23), '1%': (3.94, 5.57)},
        },
        40: {
            1: {'10%': (4.16, 4.99), '5%': (4.96, 5.93), '1%': (6.77, 7.87)},
            2: {'10%': (3.33, 4.31), '5%': (3.95, 5.04), '1%': (5.36, 6.73)},
            3: {'10%': (2.87, 3.96), '5%': (3.42, 4.60), '1%': (4.64, 5.98)},
            4: {'10%': (2.57, 3.69), '5%': (3.05, 4.28), '1%': (4.12, 5.52)},
            5: {'10%': (2.35, 3.47), '5%': (2.78, 4.00), '1%': (3.74, 5.15)},
        },
        50: {
            1: {'10%': (4.10, 4.91), '5%': (4.87, 5.79), '1%': (6.56, 7.67)},
            2: {'10%': (3.27, 4.23), '5%': (3.87, 4.92), '1%': (5.16, 6.45)},
            3: {'10%': (2.83, 3.87), '5%': (3.35, 4.47), '1%': (4.48, 5.76)},
            4: {'10%': (2.53, 3.60), '5%': (2.99, 4.16), '1%': (4.00, 5.32)},
            5: {'10%': (2.31, 3.39), '5%': (2.73, 3.90), '1%': (3.63, 4.96)},
        },
        80: {
            1: {'10%': (4.06, 4.82), '5%': (4.78, 5.65), '1%': (6.34, 7.35)},
            2: {'10%': (3.21, 4.17), '5%': (3.79, 4.79), '1%': (5.02, 6.21)},
            3: {'10%': (2.77, 3.80), '5%': (3.28, 4.36), '1%': (4.35, 5.55)},
            4: {'10%': (2.49, 3.53), '5%': (2.93, 4.06), '1%': (3.88, 5.13)},
            5: {'10%': (2.27, 3.32), '5%': (2.67, 3.81), '1%': (3.53, 4.81)},
        },
    }
}

# Default critical values (Case III - most common)
PSS_CRITICAL_VALUES = PSS_CRITICAL_VALUES_CASE_III


def get_critical_values(k, case=3, test_type='F', sample_size=None, significance='5%'):
    """
    Get critical values for bounds testing
    
    Parameters
    ----------
    k : int
        Number of I(1) regressors in long-run relationship
    case : int, default=3
        PSS case (1-5)
    test_type : str, default='F'
        Type of test ('F' or 't')
    sample_size : int, optional
        Sample size for small sample critical values (Narayan 2005)
    significance : str, default='5%'
        Significance level
    
    Returns
    -------
    tuple
        (I(0) bound, I(1) bound)
    """
    # Select appropriate case
    case_tables = {
        2: PSS_CRITICAL_VALUES_CASE_II,
        3: PSS_CRITICAL_VALUES_CASE_III,
        4: PSS_CRITICAL_VALUES_CASE_IV,
        5: PSS_CRITICAL_VALUES_CASE_V,
    }
    
    if case not in case_tables:
        case = 3  # Default to Case III
    
    cv_table = case_tables[case]
    
    # Use Narayan (2005) for small samples if available
    if sample_size and sample_size <= 80 and test_type == 'F' and case == 3:
        # Find closest sample size
        available_sizes = list(NARAYAN_CRITICAL_VALUES['F'].keys())
        closest_size = min(available_sizes, key=lambda x: abs(x - sample_size))
        
        if k in NARAYAN_CRITICAL_VALUES['F'][closest_size]:
            if significance in NARAYAN_CRITICAL_VALUES['F'][closest_size][k]:
                return NARAYAN_CRITICAL_VALUES['F'][closest_size][k][significance]
    
    # Use PSS asymptotic critical values
    if k not in cv_table[test_type]:
        # Use closest available k
        available_k = list(cv_table[test_type].keys())
        k = min(available_k, key=lambda x: abs(x - k))
    
    if significance not in cv_table[test_type][k]:
        significance = '5%'  # Default
    
    return cv_table[test_type][k][significance]


def interpret_bounds_test(f_stat, cv_lower, cv_upper):
    """
    Interpret bounds test result
    
    Parameters
    ----------
    f_stat : float
        F-statistic
    cv_lower : float
        Lower bound (I(0))
    cv_upper : float
        Upper bound (I(1))
    
    Returns
    -------
    str
        Interpretation ('Cointegration', 'No Cointegration', 'Inconclusive')
    """
    if f_stat > cv_upper:
        return 'Cointegration'
    elif f_stat < cv_lower:
        return 'No Cointegration'
    else:
        return 'Inconclusive'
